@page "/trustaccount"
@model TrustAccountModel
<style>
    .modal-dialog {
        overflow-y: initial !important
    }

    .modal-body {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        background-color: #f4f3ef;
    }

    .modal-backdrop {
        background-color: gray;
    }

    .full_modal-dialog {
        width: 1300px !important;
        height: 920 px !important;
        min-width: 1300px !important;
        min-height: 920 px !important;
        max-width: 1300px !important;
        max-height: 920 px !important;
        padding: 0 !important;
    }

    .full_modal-content {
        height: 99% !important;
        min-height: 99% !important;
    }
</style>
<!-- #region CarousalModalRegion -->

<div class="modal fade" style="min-width:500px" id="CarousalModal" tabindex="-1" role="dialog" aria-labelledby="CarousalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered  full_modal-dialog  modal-lg" role="document">
        <div class="modal-content full_modal-content">
            <div id="carouselExampleIndicator" class="carousel slide carousel-fade" data-ride="carousel">
                <ol class="carousel-indicators">
                </ol>
                <div class="carousel-inner">
                </div>
                <a class="carousel-control-prev" href="#carouselExampleIndicator" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselExampleIndicator" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>

        </div>
    </div>
</div>

<!-- #endregion CarousalModalRegion -->

<!-- #region UploadModalRegion -->

<div class="modal fade" style="min-width:500px" id="UploadModal" tabindex="-1" role="dialog" aria-labelledby="UploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered   modal-lg" role="document">
        <div class="modal-content">
            <form method="post" id="UploadForm" onsubmit='return Upload()' enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="UploadModalLabel">Upload Files</h5>
                </div>


                <div class="modal-body">
                    <div class="reg-container row">

                        <div class="col-12">
                            <input type="hidden" id="idToUpload" />

                            <label id="NameofRecordToUpload"></label>
                            <table class="table table-sm mb-1 table-borderless table-condensed"
                                   id="documentsTable"
                                   data-sticky-header="true">
                                <tr>

                                    <td>
                                        <div class="custom-file form-group mt-md-1">

                                            <input type="file" class="custom-file-input form-control" multiple asp-for="RelatedFiles" />
                                            <label class="custom-file-label text-left" for="customFile">Click to Upload ID Documents</label>
                                        </div>
                                        <div class="text-left">
                                            <span asp-validation-for="RelatedFiles" class="text-danger text-left"></span>
                                        </div>

                                    </td>
                                </tr>

                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="row w-100">
                        <div class="col-6">
                            &nbsp;
                        </div>
                        <div class="col-3 text-right">
                            <input type="submit" value="Upload" id="UploadFile" class="btn btn-outline-success" />
                        </div>
                        <div class="col-2  text-right ">
                            <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- #endregion UploadModalRegion -->

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title text-center">Trust Account</h6>
            </div>
            <div id="loadDiv" class="loading">Loading&#8230;</div>
            <div class="card-body">
                <table id="list" class="table w-100 dn table-bordered compact stripe hover">
                    <thead>
                        <tr style="        background-color: #f8f9fa;
        color: black;">
                            <th style="min-width:200px;">Month</th>
                            <th style="min-width:200px;">Reference</th>
                            <th style="min-width:200px;">DebtorCreditor</th>
                            <th style="min-width: 200px;">Description</th>
                            <th style="min-width:100px;">Amount</th>
                            <th style="min-width:100px;">Bal</th>
                            <th style="min-width:50px;">Bills</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th style="min-width:200px;"></th>
                            <th style="min-width:200px;"></th>
                            <th style="min-width:200px;"></th>
                            <th style="min-width: 200px;"></th>
                            <th style="min-width:100px;" class="sum"></th>
                            <th style="min-width:100px;"></th>
                           
                            <th style="min-width:50px;"></th>
                        </tr>
                    </tfoot>

                </table>
            </div>
        </div>
    </div>

</div>

@section scripts {
    <script>

        $(document).ready(function () {
            var dataTable = $('#list').DataTable({
                ajax: { url: '?handler=List', dataSrc: '' },
                "columns": [
                    {
                        title: "Month", data: "month",
                        render: function (data) {
                            if (data == null) return "";
                            var dt = new Date(data);
                            var month = dt.getMonth() + 1;
                            var monthvalue = "";
                            if (month < 10)
                                monthvalue = "0" + month;
                            else
                                monthvalue = "" + month;
                            return (dt.getFullYear() + "-" + monthvalue);
                        }
                    },
                    { title: "Ref1", data: "reference" },
                    { title: "Ref2", data: "debtorcreditor" },
                    { title: "Ref3", data: "description" },
                    { title: "Amt", data: "amount" },
                    { title: "Bal", data: "runningtotal" },
                    {
                        title: "Bills",
                        data: "id",
                        "render": function (data, type, row, meta) {
                            var actions = '';
                            actions += '<a  class="btn btn-success btn-round btn-icon btn-icon-mini btn-neutral" href="#" data-toggle="modal"  data-target="#CarousalModal" onClick="SetUpCarousal(' + '\'' + row.id + ';' + row.reference + '&nbsp;&nbsp;&nbsp;' + row.debtorcreditor + '&nbsp;&nbsp;&nbsp;' + row.description + ';' + '\'' + ')" ><i class="nc-icon nc-image"></i></a>'

                            actions += '<a  class="btn btn-success btn-round btn-icon btn-icon-mini btn-neutral" href="#" data-toggle="modal"  data-target="#UploadModal" onClick="SetUpPopupToUploadRecord(' + '\'' + row.id + ';' + row.reference + '&nbsp;&nbsp;&nbsp;' + row.debtorcreditor + '&nbsp;&nbsp;&nbsp;' + row.description + ';' + '\'' + ')" ><i class="nc-icon nc-cloud-upload-94"></i></a>'
                            return actions;
                        },
                        orderable: false,
                        width: "50px"
                    }
                  
                ],

                drawCallback: function () {
                    var api = this.api();
                    $(api.table().column(4).footer()).html(
                        api.column(4, { page: 'current' }).data().sum().toFixed(2)
                    );
                }


            });
            yadcf.init(dataTable, [
                { column_number: 0, filter_type: 'multi_select', select_type: 'chosen', select_type_options: { width: '250px' } },
                { column_number: 1, filter_type: 'text' },
                { column_number: 2, filter_type: 'text' },
                { column_number: 3, filter_type: 'text' },
          /*      { column_number: 4, filter_type: 'text' },*/

            ]);


        });

        function SetUpPopupToUploadRecord(data) {
            var dataarray = data.split(";")
            $('#idToUpload').val(dataarray[0]);
            $('#NameofRecordToUpload').text(dataarray[1]);
        }

        function SetUpCarousal(data) {
            var dataarray = data.split(";")
            var fileData = new FormData();
            var item="";
            var indicators="";
            fileData.append("id", dataarray[0]);

            $.ajax({
                type: "Post",
                url: "?handler=GetImages",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                contentType: false,
                processData: false,
                data: fileData,
                success: function (data) {
                    for (var i = 0; i < data.length; i++) {
                        indicators += "<li data-target='#carouselExampleIndicator' data-slide-to=" + i + "></li>";
                        item += "<div class='carousel-item'><img class='d-block w-100' src='_Documents/" + data[i] + "'></div>";
                      
                    }
                   
                    //append to a div container
                    $("ol.carousel-indicators").append(indicators);
                    $("div.carousel-inner").append(item);
                    $("div.carousel-item").eq(0).addClass("active");
                    $("ol.carousel-indicators").eq(0).addClass("active");
                },
                error: function (err) {
                    alert(err);
                }

            })

            $('#NameofRecordToUpload').text(dataarray[1]);
        }

        $("#UploadFile").click(function (e) {

            e.preventDefault();

            var files = $("#RelatedFiles").get(0).files;
            var fileData = new FormData();
            fileData.append("id", $('#idToUpload').val());
            for (var i = 0; i < files.length; i++) {
                fileData.append("fileInput", files[i]);
            }
            $.ajax({
                type: "POST",
                beforeSend: function () { $('.ajax-loader').css("visibility", "visible"); },
                url: '?handler=UploadAllFiles',
                dataType: "json",
                contentType: false,
                processData: false,
                data: fileData,
                success: function (data) {
                    if (data.success) {
                        MMNotify(data.message, "success");
                    }
                    else {
                        MMNotify(data.message, "danger");
                    }
                },
                complete: function () { $('.ajax-loader').css("visibility", "hidden"); }
            });
        });

    </script>

}